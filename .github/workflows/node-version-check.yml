name: Node.jsãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ç›£è¦–

on:
  schedule:
    # æ¯æœˆ1æ—¥ã®æ·±å¤œ3æ™‚ã«å®Ÿè¡Œ
    - cron: '0 18 1 * *'  # UTC 18:00 = JST 03:00
  workflow_dispatch:

jobs:
  check-node-version:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: æœ€æ–°ã®Node.js LTSãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—
        id: node-version
        run: |
          LATEST_LTS=$(curl -s https://nodejs.org/dist/index.json | jq -r '[.[] | select(.lts != false)] | .[0].version' | sed 's/v//')
          CURRENT_VERSION=$(cat package.json | jq -r '.engines.node' | sed 's/>=//;s/\.0\.0$//')
          
          echo "latest_lts=$LATEST_LTS" >> $GITHUB_OUTPUT
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          
          # ãƒ¡ã‚¸ãƒ£ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æ¯”è¼ƒ
          LATEST_MAJOR=$(echo $LATEST_LTS | cut -d. -f1)
          CURRENT_MAJOR=$(echo $CURRENT_VERSION | cut -d. -f1)
          
          echo "latest_major=$LATEST_MAJOR" >> $GITHUB_OUTPUT
          echo "current_major=$CURRENT_MAJOR" >> $GITHUB_OUTPUT

      - name: ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒå¤ã„å ´åˆã¯Issueã‚’ä½œæˆ
        if: steps.node-version.outputs.latest_major > steps.node-version.outputs.current_major
        uses: actions/github-script@v8
        with:
          script: |
            const latestLTS = '${{ steps.node-version.outputs.latest_lts }}';
            const currentVersion = '${{ steps.node-version.outputs.current_version }}';
            
            const issueBody = `# ğŸš€ Node.jsã®æ–°ã—ã„LTSãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒåˆ©ç”¨å¯èƒ½ã§ã™
            
            **ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: ${currentVersion}  
            **æœ€æ–°ã®LTSãƒãƒ¼ã‚¸ãƒ§ãƒ³**: ${latestLTS}
            
            ## ğŸ“‹ æ›´æ–°æ‰‹é †
            
            ### 1. ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§Node.jsã‚’æ›´æ–°
            \`\`\`bash
            # nvmã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆ
            nvm install ${latestLTS}
            nvm use ${latestLTS}
            nvm alias default ${latestLTS}
            
            # ã¾ãŸã¯å…¬å¼ã‚µã‚¤ãƒˆã‹ã‚‰ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ©ãƒ¼ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            # https://nodejs.org/
            \`\`\`
            
            ### 2. package.jsonã®enginesã‚’æ›´æ–°
            \`\`\`json
            {
              "engines": {
                "node": ">=${latestLTS.split('.')[0]}.0.0",
                "npm": ">=10.0.0"
              }
            }
            \`\`\`
            
            ### 3. ä¾å­˜é–¢ä¿‚ã®å†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨ãƒ†ã‚¹ãƒˆ
            \`\`\`bash
            # æ—¢å­˜ã®node_modulesã‚’å‰Šé™¤
            rm -rf node_modules client/node_modules server/node_modules
            rm package-lock.json client/package-lock.json server/package-lock.json
            
            # å†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
            npm install
            cd client && npm install
            cd ../server && npm install
            
            # å‹•ä½œç¢ºèª
            npm run dev
            \`\`\`
            
            ### 4. ãƒ‡ãƒ—ãƒ­ã‚¤ç’°å¢ƒã®æ›´æ–°
            - ã‚µãƒ¼ãƒãƒ¼ã®Node.jsãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æ›´æ–°
            - CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®è¨­å®šã‚’æ›´æ–°
            - Dockerfileã®ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’æ›´æ–°ï¼ˆä½¿ç”¨ã™ã‚‹å ´åˆï¼‰
            
            ## âš ï¸ æ³¨æ„äº‹é …
            - äº’æ›æ€§ã®ãªã„å¤‰æ›´ãŒã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™
            - æœ¬ç•ªç’°å¢ƒã¸ã®é©ç”¨å‰ã«ååˆ†ãªãƒ†ã‚¹ãƒˆã‚’å®Ÿæ–½ã—ã¦ãã ã•ã„
            - é–¢é€£ã™ã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚‚æ›´æ–°ãŒå¿…è¦ãªå ´åˆãŒã‚ã‚Šã¾ã™
            
            ## ğŸ”— å‚è€ƒãƒªãƒ³ã‚¯
            - [Node.js ${latestLTS} ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆ](https://nodejs.org/en/blog/release/)
            - [Node.js LTS ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«](https://github.com/nodejs/release#release-schedule)
            `;
            
            // æ—¢å­˜ã®Node.jsæ›´æ–°Issueã‚’æ¤œç´¢
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['node.js', 'upgrade'],
              state: 'open'
            });
            
            if (issues.data.length === 0) {
              // æ–°ã—ã„Issueã‚’ä½œæˆ
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ğŸš€ Node.js ${latestLTS} LTSã¸ã®ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰`,
                body: issueBody,
                labels: ['node.js', 'upgrade', 'enhancement']
              });
            }
