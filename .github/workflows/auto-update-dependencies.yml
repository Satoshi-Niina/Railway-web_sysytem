name: ä¾å­˜é–¢ä¿‚ã®è‡ªå‹•æ›´æ–°PRä½œæˆ

on:
  schedule:
    # æ¯é€±æœˆæ›œæ—¥ã®æ·±å¤œ2æ™‚ã«å®Ÿè¡Œ
    - cron: '0 17 * * 1'  # UTC 17:00 = JST 02:00
  workflow_dispatch:

jobs:
  auto-update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          ref: docker
          fetch-depth: 0

      - name: Node.js 22ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v6
        with:
          node-version: '22'
          cache: 'npm'

      - name: npm-check-updatesã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm install -g npm-check-updates

      - name: ãƒ‘ãƒƒãƒãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è‡ªå‹•æ›´æ–°
        run: |
          # ãƒ‘ãƒƒãƒãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ã¿è‡ªå‹•æ›´æ–°ï¼ˆå®‰å…¨æ€§ãŒé«˜ã„ï¼‰
          ncu -u --target patch
          cd client && ncu -u --target patch
          cd ../server && ncu -u --target patch

      - name: ä¾å­˜é–¢ä¿‚ã‚’å†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          npm install
          cd client && npm install
          cd ../server && npm install

      - name: ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
        continue-on-error: true
        run: |
          npm test || echo "ãƒ†ã‚¹ãƒˆãŒã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã—ãŸ"

      - name: å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        id: check-changes
        run: |
          git diff --exit-code || echo "has_changes=true" >> $GITHUB_OUTPUT

      - name: PRãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆ
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          BRANCH_NAME="auto-update-deps-$(date +%Y%m%d)"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git checkout -b $BRANCH_NAME
          git add -A
          git commit -m "ğŸ”„ ä¾å­˜é–¢ä¿‚ã®è‡ªå‹•æ›´æ–°ï¼ˆãƒ‘ãƒƒãƒãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼‰

          - ãƒ«ãƒ¼ãƒˆã€clientã€serverã®ãƒ‘ãƒƒãƒãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æ›´æ–°
          - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‘ãƒƒãƒã¨äº’æ›æ€§ã®é«˜ã„æ›´æ–°ã®ã¿
          
          è‡ªå‹•ç”ŸæˆPR by GitHub Actions"
          git push -u origin $BRANCH_NAME
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Pull Requestã‚’ä½œæˆ
        if: steps.check-changes.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const branchName = '${{ steps.check-changes.outputs.branch_name }}';
            
            await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸ”„ ä¾å­˜é–¢ä¿‚ã®è‡ªå‹•æ›´æ–°ï¼ˆãƒ‘ãƒƒãƒãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼‰',
              body: `## ğŸ“¦ è‡ªå‹•æ›´æ–°ã®å†…å®¹
              
              ã“ã®PRã¯å®‰å…¨æ€§ã®é«˜ã„ãƒ‘ãƒƒãƒãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®æ›´æ–°ã‚’å«ã‚“ã§ã„ã¾ã™ã€‚
              
              ### æ›´æ–°ç¯„å›²
              - âœ… ãƒ‘ãƒƒãƒãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼ˆä¾‹: 1.0.0 â†’ 1.0.1ï¼‰
              - âŒ ãƒã‚¤ãƒŠãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼ˆæ‰‹å‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼å¿…è¦ï¼‰
              - âŒ ãƒ¡ã‚¸ãƒ£ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼ˆæ‰‹å‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼å¿…è¦ï¼‰
              
              ### ç¢ºèªäº‹é …
              - [ ] ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
              - [ ] é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ãŒæ­£å¸¸èµ·å‹•
              - [ ] ä¸»è¦æ©Ÿèƒ½ã®å‹•ä½œç¢ºèª
              
              ### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
              1. ã“ã®PRã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼
              2. å•é¡Œãªã‘ã‚Œã°ãƒãƒ¼ã‚¸
              3. ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã«æœ¬ç•ªç’°å¢ƒã§å‹•ä½œç¢ºèª
              
              ---
              
              ğŸ¤– ã“ã®PRã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸï¼ˆæ¯é€±æœˆæ›œæ—¥ï¼‰
              `,
              head: branchName,
              base: 'docker',
              labels: ['dependencies', 'automated', 'patch-update']
            });
