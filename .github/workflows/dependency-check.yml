name: ä¾å­˜é–¢ä¿‚ã®è‡ªå‹•ãƒã‚§ãƒƒã‚¯ã¨é€šçŸ¥

on:
  # æ¯é€±æ—¥æ›œæ—¥ã®æ·±å¤œ3æ™‚ã«å®Ÿè¡Œ
  schedule:
    - cron: '0 18 * * 0'  # UTC 18:00 = JST 03:00
  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:
  # PRãŒä½œæˆã•ã‚ŒãŸæ™‚ã‚‚å®Ÿè¡Œ
  pull_request:
    paths:
      - '**/package.json'
      - '**/package-lock.json'

jobs:
  check-dependencies:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Node.js 22ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          npm ci
          cd client && npm ci
          cd ../server && npm ci

      - name: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ã‚’å®Ÿè¡Œ
        id: audit
        continue-on-error: true
        run: |
          echo "## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»çµæœ" > audit-report.md
          echo "" >> audit-report.md
          
          echo "### ãƒ«ãƒ¼ãƒˆ" >> audit-report.md
          npm audit --json > root-audit.json || true
          cat root-audit.json | jq -r '.vulnerabilities | to_entries[] | "- **\(.key)**: \(.value.severity) - \(.value.via[0].title // "è„†å¼±æ€§ã‚ã‚Š")"' >> audit-report.md
          
          echo "" >> audit-report.md
          echo "### Client" >> audit-report.md
          cd client
          npm audit --json > ../client-audit.json || true
          cd ..
          cat client-audit.json | jq -r '.vulnerabilities | to_entries[] | "- **\(.key)**: \(.value.severity) - \(.value.via[0].title // "è„†å¼±æ€§ã‚ã‚Š")"' >> audit-report.md
          
          echo "" >> audit-report.md
          echo "### Server" >> audit-report.md
          cd server
          npm audit --json > ../server-audit.json || true
          cd ..
          cat server-audit.json | jq -r '.vulnerabilities | to_entries[] | "- **\(.key)**: \(.value.severity) - \(.value.via[0].title // "è„†å¼±æ€§ã‚ã‚Š")"' >> audit-report.md

      - name: æ›´æ–°å¯èƒ½ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ç¢ºèª
        id: updates
        run: |
          npm install -g npm-check-updates
          
          echo "## æ›´æ–°å¯èƒ½ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸" > updates-report.md
          echo "" >> updates-report.md
          
          echo "### ãƒ«ãƒ¼ãƒˆ" >> updates-report.md
          ncu --format json > root-updates.json || echo "{}" > root-updates.json
          cat root-updates.json | jq -r 'to_entries[] | "- **\(.key)**: \(.value.current) â†’ \(.value.latest)"' >> updates-report.md
          
          echo "" >> updates-report.md
          echo "### Client" >> updates-report.md
          cd client
          ncu --format json > ../client-updates.json || echo "{}" > ../client-updates.json
          cd ..
          cat client-updates.json | jq -r 'to_entries[] | "- **\(.key)**: \(.value.current) â†’ \(.value.latest)"' >> updates-report.md
          
          echo "" >> updates-report.md
          echo "### Server" >> updates-report.md
          cd server
          ncu --format json > ../server-updates.json || echo "{}" > ../server-updates.json
          cd ..
          cat server-updates.json | jq -r 'to_entries[] | "- **\(.key)**: \(.value.current) â†’ \(.value.latest)"' >> updates-report.md

      - name: é‡å¤§ãªè„†å¼±æ€§ãŒã‚ã‚‹å ´åˆã¯è‡ªå‹•ä¿®æ­£
        if: steps.audit.outcome == 'failure'
        run: |
          npm audit fix --force
          cd client && npm audit fix --force
          cd ../server && npm audit fix --force

      - name: è‡ªå‹•ä¿®æ­£å¾Œã®å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ
        if: steps.audit.outcome == 'failure'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add -A
          git diff --staged --quiet || git commit -m "ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: è„†å¼±æ€§ã®è‡ªå‹•ä¿®æ­£"
          git push

      - name: Issueã‚’ä½œæˆã—ã¦é€šçŸ¥
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let auditReport = 'è„†å¼±æ€§ãªã— âœ…';
            let updatesReport = 'æ›´æ–°ãªã— âœ…';
            
            try {
              auditReport = fs.readFileSync('audit-report.md', 'utf8');
            } catch (e) {}
            
            try {
              updatesReport = fs.readFileSync('updates-report.md', 'utf8');
            } catch (e) {}
            
            const issueBody = `# ğŸ“¦ ä¾å­˜é–¢ä¿‚ã®å®šæœŸãƒã‚§ãƒƒã‚¯çµæœ
            
            **å®Ÿè¡Œæ—¥æ™‚**: ${new Date().toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' })}
            
            ${auditReport}
            
            ---
            
            ${updatesReport}
            
            ---
            
            ## ğŸ“ å¯¾å¿œæ–¹æ³•
            
            ### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ã®ä¿®æ­£
            \`\`\`bash
            npm audit fix
            cd client && npm audit fix
            cd server && npm audit fix
            \`\`\`
            
            ### ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®æ›´æ–°
            \`\`\`bash
            npm run update:interactive
            \`\`\`
            
            ### å…¨è‡ªå‹•æ›´æ–°ï¼ˆæ³¨æ„ï¼‰
            \`\`\`bash
            npm run update:all
            \`\`\`
            `;
            
            // æ—¢å­˜ã®Issueã‚’æ¤œç´¢
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['dependencies', 'automated'],
              state: 'open'
            });
            
            if (issues.data.length > 0) {
              // æ—¢å­˜Issueã«ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ 
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: issueBody
              });
            } else {
              // æ–°ã—ã„Issueã‚’ä½œæˆ
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ğŸ“¦ ä¾å­˜é–¢ä¿‚ã®æ›´æ–°ãŒåˆ©ç”¨å¯èƒ½ã§ã™',
                body: issueBody,
                labels: ['dependencies', 'automated']
              });
            }
